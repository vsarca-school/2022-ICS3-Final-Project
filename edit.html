<!DOCTYPE html>
<html>
<link rel="stylesheet" href="style.css">

<head>
    <title>LearnAI.js - Editor</title>
</head>

<body class="noMargin">
    <script>
        var card;
        var table;

        var empty;
        var image_editor;
        var code_editor;
        let counter = 0;
        document.body.onload = function (event) {
            let temp = document.getElementById("card");
            card = temp.cloneNode(true);
            card.removeAttribute("id");
            temp.remove();

            table = document.getElementById("card-holder");

            temp = document.getElementById("empty");
            empty = temp.cloneNode(true);
            empty.removeAttribute("id");
            temp.remove();
            temp = document.getElementById("Image Editor");
            image_editor = temp.cloneNode(true);
            image_editor.removeAttribute("id");
            temp.remove();
            temp = document.getElementById("Code Editor");
            code_editor = temp.cloneNode(true);
            code_editor.removeAttribute("id");
            temp.remove();
        }

        function plusButton() {
            if (counter < 5) {
                let newNode = card.cloneNode(true);
                table.appendChild(newNode);
                let newScript = document.createElement("script");
                newScript.src = "card.js";
                newNode.appendChild(newScript);
                counter++;
            }
        }

        function remove(el) {
            el.parentElement.parentElement.remove();
            counter--;
        }
    </script>

    <div class="topBar">
        <a href="index.html"><button class="arrow"><<</button></a>
        <button class="plus" onclick="plusButton()">+</button>
    </div>
    <div>
        <table class="fullscreen">
            <tr class="fullscreen" id="card-holder">
                <td id="card" class="fullscreen row">
                    <div class="selection drop-div">
                        <select style="width: 20%;" class="selection dropdown">
                            <option value="empty"></option>
                            <option value="Image Editor">Image Editor</option>
                            <option value="Code Editor">Code Editor</option>
                        </select>
                        <button class="close" onclick="remove(this)">X</button>
                    </div>
                    <div class="content"></div>
                </td>
            </tr>
        </table>

        <div class="content" id="empty"></div>
        <div class="content" id="Image Editor">
            <div id="canvas_div" style="overflow-x: auto;">
                <button onclick="javascript:clearArea();return false;">Clear Area</button>
                Line width : <select id="selWidth">
                    <option value="11">11</option>
                    <option value="13" selected="selected">13</option>
                    <option value="15">15</option>
                </select>
                Color : <select id="selColor">
                    <option value="black">black</option>
                    <option value="blue" selected="selected">blue</option>
                    <option value="red">red</option>
                    <option value="green">green</option>
                    <option value="yellow">yellow</option>
                    <option value="gray">gray</option>
                </select>
            </div>
            <canvas id="draw" width="28" height="28"></canvas>
            <script>
                const canvas = document.getElementById("draw");
                const ctx = canvas.getctx('2d');
                let isDrawing = false;
                let x = 0;
                let y = 0;
                var offsetX;
                var offsetY;

                function startup() {
                    canvas.addEventListener('touchstart', handleStart);
                    canvas.addEventListener('touchend', handleEnd);
                    canvas.addEventListener('touchcancel', handleCancel);
                    canvas.addEventListener('touchmove', handleMove);
                    canvas.addEventListener('mousedown', (e) => {
                        x = e.offsetX;
                        y = e.offsetY;
                        isDrawing = true;
                    });

                    canvas.addEventListener('mousemove', (e) => {
                        if (isDrawing) {
                            drawLine(ctx, x, y, e.offsetX, e.offsetY);
                            x = e.offsetX;
                            y = e.offsetY;
                        }
                    });

                    canvas.addEventListener('mouseup', (e) => {
                        if (isDrawing) {
                            drawLine(ctx, x, y, e.offsetX, e.offsetY);
                            x = 0;
                            y = 0;
                            isDrawing = false;
                        }
                    });
                }

                document.addEventListener("DOMContentLoaded", startup);

                const ongoingTouches = [];

                function handleStart(evt) {
                    evt.preventDefault();
                    const touches = evt.changedTouches;
                    offsetX = canvas.getBoundingClientRect().left;
                    offsetY = canvas.getBoundingClientRect().top;
                    for (let i = 0; i < touches.length; i++) {
                        ongoingTouches.push(copyTouch(touches[i]));
                    }
                }

                function handleMove(evt) {
                    evt.preventDefault();
                    const touches = evt.changedTouches;
                    for (let i = 0; i < touches.length; i++) {
                        const color = document.getElementById('selColor').value;
                        const idx = ongoingTouchIndexById(touches[i].identifier);
                        if (idx >= 0) {
                            ctx.beginPath();
                            ctx.moveTo(ongoingTouches[idx].clientX - offsetX, ongoingTouches[idx].clientY - offsetY);
                            ctx.lineTo(touches[i].clientX - offsetX, touches[i].clientY - offsetY);
                            ctx.lineWidth = document.getElementById('selWidth').value;
                            ctx.strokeStyle = color;
                            ctx.lineJoin = "round";
                            ctx.closePath();
                            ctx.stroke();
                            ongoingTouches.splice(idx, 1, copyTouch(touches[i]));  // swap in the new touch record
                        }
                    }
                }

                function handleEnd(evt) {
                    evt.preventDefault();
                    const touches = evt.changedTouches;
                    for (let i = 0; i < touches.length; i++) {
                        const color = document.getElementById('selColor').value;
                        let idx = ongoingTouchIndexById(touches[i].identifier);
                        if (idx >= 0) {
                            ctx.lineWidth = document.getElementById('selWidth').value;
                            ctx.fillStyle = color;
                            ongoingTouches.splice(idx, 1);  // remove it; we're done
                        }
                    }
                }

                function handleCancel(evt) {
                    evt.preventDefault();
                    const touches = evt.changedTouches;
                    for (let i = 0; i < touches.length; i++) {
                        let idx = ongoingTouchIndexById(touches[i].identifier);
                        ongoingTouches.splice(idx, 1);  // remove it; we're done
                    }
                }

                function copyTouch({ identifier, clientX, clientY }) {
                    return { identifier, clientX, clientY };
                }

                function ongoingTouchIndexById(idToFind) {
                    for (let i = 0; i < ongoingTouches.length; i++) {
                        const id = ongoingTouches[i].identifier;
                        if (id === idToFind) {
                            return i;
                        }
                    }
                    return -1;    // not found
                }

                function drawLine(ctx, x1, y1, x2, y2) {
                    ctx.beginPath();
                    ctx.strokeStyle = document.getElementById('selColor').value;
                    ctx.lineWidth = document.getElementById('selWidth').value;
                    ctx.lineJoin = "round";
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.closePath();
                    ctx.stroke();
                }

                function clearArea() {
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                }
            </script>
        </div>
        <div class="content" id="Code Editor">Code Editor</div>
    </div>
</body>

</html>